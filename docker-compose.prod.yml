services:
  duo-gym:
    # Use the image built by CD pipeline
    image: ghcr.io/${REPO_LOWER}/duo-gym:latest
    container_name: duo-gym
    restart: always
    ports:
      - "8081:80"
    depends_on:
      - backend
    environment:
      - NODE_ENV=production

  backend:
    # Use the image built by CD pipeline
    image: ghcr.io/${REPO_LOWER}/backend:latest
    container_name: duo-gym-backend
    restart: always
    ports:
      - "3002:3001"
    volumes:
      # Only persist the database
      - ./backend/prisma:/app/prisma
    environment:
      - DATABASE_URL=file:./dev.db
      - JWT_SECRET=${JWT_SECRET}
      - PORT=3001
      - NODE_ENV=production
    command: sh -c "npx prisma db push && npm start"
